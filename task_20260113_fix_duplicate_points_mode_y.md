# Task: Исправление дублирующихся точек в режиме 'Y'

**Date:** 2026-01-13  
**Status:** ✅ Complete  
**Priority:** High  
**Assignee:** AI Assistant  
**Related Files:** 
- `TableGraphEditor/src/helpers/updateDataFromGraph.m`

---

## Проблема

В режиме 'Y' при перетаскивании точки периодически возникают дублирующиеся точки с одинаковой координатой X. Например, у кривой 1 (Column 2) возникают две точки с координатой X = 6.0000.

**Симптомы:**
- При перетаскивании точки в режиме 'Y' появляются дублирующиеся точки
- На графике отображаются две или более точки с одинаковой координатой X для одной кривой
- Это происходит даже при том, что координата X не должна изменяться в режиме 'Y'

---

## Анализ причин

### Корневая причина

Проблема была в логике определения индекса строки/столбца данных (`dataRowIdx`/`dataColIdx`) в функции `updateDataFromGraph`. Использовался `pointIdx` (индекс точки в кривой после фильтрации NaN), который **может измениться** при перетаскивании, если какие-то точки становятся NaN.

**Цепочка событий:**

1. **Исходное состояние:**
   ```
   Данные: строки 2, 3, 4, 5 (все валидны)
   pointIdx = 2 → dataRowIdx = 3 (строка 3)
   ```

2. **При перетаскивании:**
   - Если какая-то точка становится NaN (из-за удаления дубликатов или других причин)
   - `validIndicesList` изменяется: [2, 4, 5] (строка 3 стала NaN)
   - При следующем обновлении `pointIdx = 2` → `dataRowIdx = 4` (строка 4) вместо строки 3!

3. **Результат:**
   - Обновляется не та строка
   - Может появиться дубликат, если координата X строки 4 совпадает с координатой X строки 3
   - Или данные обновляются в неправильной строке, создавая дубликаты

### Дополнительные факторы

1. **Нестабильность `pointIdx`**: Индекс точки в кривой после фильтрации NaN может изменяться при перетаскивании
2. **Отсутствие проверки**: Не было проверки, что обновляется правильная строка/столбец
3. **Режим 'Y'**: Координата X не изменяется, но это не гарантирует, что обновляется правильная строка

---

## Решение

### Алгоритм надежного определения строки/столбца

Реализован **механизм использования исходной координаты X** для определения правильной строки/столбца вместо нестабильного `pointIdx`:

1. **Получить исходную координату X** из `dragStartCoordinates` (сохраняется при начале перетаскивания)
2. **Найти строку/столбец** с такой же координатой X в данных
3. **Использовать `pointIdx` как fallback**, если исходная координата X не найдена

### Преимущества решения

1. **Надежность**: Использование исходной координаты X гарантирует, что обновляется правильная строка/столбец
2. **Стабильность**: Координата X не изменяется в режиме 'Y', поэтому она всегда доступна
3. **Fallback**: Если исходная координата X не найдена, используется `pointIdx` как запасной вариант
4. **Дополнительная проверка**: Проверка совпадения координат X из данных и из `dragStartCoordinates`

### Код решения

#### Для режима "по столбцам":

```matlab
% Попытаться получить исходную координату X из dragStartCoordinates
originalX = [];
% ... получение из dragStartCoordinates ...

if isempty(originalX)
    % Fallback: использовать pointIdx
    % ... логика с pointIdx ...
else
    % Использовать исходную координату X для поиска правильной строки
    xData = currentData(2:end, 1);
    tolerance = 1e-10;
    dataRowIdx = [];
    for row = 2:size(currentData, 1)
        if isfinite(xData(row-1)) && abs(xData(row-1) - originalX) < tolerance
            if isfinite(currentData(row, colY))
                dataRowIdx = row;
                break;
            end
        end
    end
    % Если не найдена, использовать pointIdx как fallback
    if isempty(dataRowIdx)
        % ... логика с pointIdx ...
    end
end
```

#### Для режима "по строкам":

Аналогичная логика, но для поиска столбца по координате X.

#### Дополнительная проверка в режиме 'Y':

```matlab
case 'Y'
    originalX = currentData(dataRowIdx, 1);
    
    % Проверить совпадение координат X из данных и из dragStartCoordinates
    if ~isempty(dragStartX) && abs(originalX - dragStartX) > 1e-10
        fprintf('⚠ Предупреждение: координата X в данных (%.4f) не совпадает с исходной (%.4f)\n', ...
            originalX, dragStartX);
        originalX = dragStartX; % Использовать исходную координату X
    end
    
    currentData(dataRowIdx, 1) = originalX; % X - сохранить исходную
    currentData(dataRowIdx, colY) = newPosition(2); % Y - обновить
```

---

## Реализованные изменения

### `updateDataFromGraph.m` (обновлен)

**Изменения:**

1. **Для режима "по столбцам"** (строки ~161-220):
   - Добавлено получение исходной координаты X из `dragStartCoordinates`
   - Поиск строки по исходной координате X вместо использования `pointIdx`
   - Fallback на `pointIdx`, если исходная координата X не найдена

2. **Для режима "по строкам"** (строки ~468-540):
   - Добавлено получение исходной координаты X из `dragStartCoordinates`
   - Поиск столбца по исходной координате X вместо использования `pointIdx`
   - Fallback на `pointIdx`, если исходная координата X не найдена

3. **Дополнительная проверка в режиме 'Y'** (строки ~217-250 и ~540-580):
   - Проверка совпадения координат X из данных и из `dragStartCoordinates`
   - Предупреждение, если координаты не совпадают
   - Использование исходной координаты X из `dragStartCoordinates` для надежности

---

## Тестирование

### Тестовый сценарий

1. **Подготовка данных:**
   - Создать данные с точками: X=[4, 6, 8], Y=[0.5, 0.6, 0.7] для столбца 2

2. **Тест 1: Режим 'Y' - перетаскивание точки**
   - Выбрать режим 'Y'
   - Перетащить точку с X=4.0 (изменяется только Y)
   - **Ожидаемый результат**: Обновляется правильная строка (строка с X=4.0), дубликаты не появляются

3. **Тест 2: Режим 'Y' - после удаления дубликатов**
   - Создать ситуацию с дубликатами (если возможно)
   - Перетащить точку в режиме 'Y'
   - **Ожидаемый результат**: Обновляется правильная строка, даже если `pointIdx` изменился

4. **Тест 3: Режим 'Y' - проверка исходной координаты X**
   - Перетащить точку в режиме 'Y'
   - Проверить консоль на наличие предупреждений о несовпадении координат
   - **Ожидаемый результат**: Координаты X должны совпадать, предупреждений не должно быть

### Ожидаемое поведение

- ✅ При перетаскивании точки в режиме 'Y' обновляется правильная строка/столбец
- ✅ Дубликаты не появляются, даже если `pointIdx` изменился
- ✅ Координата X остается постоянной и используется для надежного определения строки/столбца
- ✅ В консоли появляются сообщения о найденной строке/столбце по исходной координате X

---

## Дополнительные улучшения

### Рекомендации для будущих улучшений

1. **Кэширование индекса строки/столбца**: 
   - Сохранять индекс строки/столбца при начале перетаскивания
   - Использовать его для обновления данных
   - Это может быть еще более надежным решением

2. **Валидация данных**: 
   - Добавить проверку, что обновляется правильная строка/столбец
   - Предупреждать пользователя о возможных проблемах

3. **Оптимизация производительности**: 
   - Кэшировать результаты поиска строки/столбца
   - Избежать повторного поиска при каждом обновлении

---

## Заключение

Проблема была вызвана тем, что `updateDataFromGraph` использовала нестабильный `pointIdx` для определения строки/столбца данных. Решение обеспечивает **надежное определение строки/столбца** через исходную координату X:

1. **Использование исходной координаты X**: Координата X не изменяется в режиме 'Y', поэтому она всегда доступна и стабильна
2. **Поиск по координате**: Поиск строки/столбца по исходной координате X гарантирует, что обновляется правильная строка/столбец
3. **Fallback механизм**: Если исходная координата X не найдена, используется `pointIdx` как запасной вариант
4. **Дополнительная проверка**: Проверка совпадения координат X из данных и из `dragStartCoordinates` для дополнительной надежности

Это гарантирует, что в режиме 'Y' всегда обновляется правильная строка/столбец, и дубликаты не появляются.

---

## Sign-off

**Completed by:** AI Assistant  
**Date:** 2026-01-13  
**Status:** ✅ Complete  
**Result:** Реализовано надежное определение строки/столбца через исходную координату X в режиме 'Y'

