# Task: Исправление накопления кривых и дублирования легенды при перерисовке графика

**Date:** 2026-01-14  
**Status:** ✅ Complete and Tested (2026-01-14)  
**Priority:** High  
**Assignee:** AI Assistant  
**Related Files:** 
- `TableGraphEditor/src/helpers/plotByColumns.m`
- `TableGraphEditor/src/helpers/plotByRows.m`

---

## Проблема

При перетаскивании точки в режиме 'Y' на графике появляются дублирующиеся кривые и записи в легенде. В легенде отображаются два комплекта всех трех кривых (например, "0.1", "0.5", "1", "0.1", "0.5", "1"). Все неподвижные точки накладываются друг на друга, а редактируемая точка изображается дважды.

**Симптомы:**
- В легенде появляются дублирующиеся записи для всех кривых
- На графике видны наложенные друг на друга кривые
- Редактируемая точка отображается дважды
- Проблема возникает при перетаскивании точки в режиме 'Y'

---

## Анализ причин

### Корневая причина

Проблема была в **неполной очистке графика** перед перерисовкой:

1. **Легенда не удалялась явно**: В MATLAB `cla` (clear axes) может не удалять легенду полностью, особенно если она была создана недавно
2. **`legend('show')` добавляет записи**: Если легенда уже существует, `legend('show')` может добавлять новые записи к существующим, а не заменять их
3. **Графические объекты могут оставаться**: Иногда `cla` не удаляет все графические объекты, особенно если они были созданы недавно или в быстрой последовательности

**Цепочка событий:**

1. **Первая перерисовка:**
   - `plotByColumns` вызывается
   - `cla` очищает график (но легенда может остаться)
   - Строятся кривые 1, 2, 3
   - Создается легенда: ["0.1", "0.5", "1"]

2. **Вторая перерисовка (при перетаскивании):**
   - `plotByColumns` вызывается снова
   - `cla` очищает график (но старая легенда может остаться)
   - Строятся новые кривые 1, 2, 3 (поверх старых, если они не были удалены)
   - `legend('show')` добавляет новые записи к существующей легенде
   - Результат: легенда содержит ["0.1", "0.5", "1", "0.1", "0.5", "1"]

3. **Накопление:**
   - При каждой перерисовке добавляются новые кривые и записи в легенду
   - График становится все более "замусоренным"

### Дополнительные факторы

1. **Частые обновления**: При перетаскивании `updateGraph` вызывается очень часто (через `drawnow limitrate`)
2. **Асинхронность**: `cla` может не успевать удалить все объекты перед созданием новых
3. **Легенда как отдельный объект**: Легенда в MATLAB - это отдельный объект, который может не удаляться `cla`

---

## Решение

### Алгоритм надежной очистки графика

Реализован **трехуровневый механизм очистки**:

1. **Уровень 1: Явное удаление легенды**
   - Проверить наличие легенды
   - Удалить легенду явно перед очисткой графика

2. **Уровень 2: Очистка через `cla`**
   - Использовать `cla` для очистки всех графических объектов

3. **Уровень 3: Проверка и удаление оставшихся линий**
   - Проверить, остались ли линии после `cla`
   - Удалить оставшиеся линии явно

4. **Уровень 4: Создание новой легенды**
   - Убедиться, что старая легенда удалена перед созданием новой
   - Создать новую легенду только если есть кривые

### Код решения

#### Для `plotByColumns` и `plotByRows`:

```matlab
% Уровень 1: Явное удаление легенды перед очисткой
try
    if ~isempty(app.axPlot.Legend) && isvalid(app.axPlot.Legend)
        delete(app.axPlot.Legend);
    end
catch
    % Игнорировать ошибки при удалении легенды
end

% Уровень 2: Очистка через cla
cla(app.axPlot);

% Уровень 3: Проверка и удаление оставшихся линий
children = app.axPlot.Children;
if ~isempty(children)
    linesToDelete = [];
    for i = 1:length(children)
        if isa(children(i), 'matlab.graphics.chart.primitive.Line')
            linesToDelete = [linesToDelete, i];
        end
    end
    if ~isempty(linesToDelete)
        fprintf('⚠ После cla остались линии (%d), удаление...\n', length(linesToDelete));
        delete(children(linesToDelete));
    end
end

% ... построение кривых ...

% Уровень 4: Создание новой легенды
% Убедиться, что старая легенда удалена перед созданием новой
if ~isempty(app.axPlot.Legend)
    delete(app.axPlot.Legend);
end

% Создать новую легенду только если есть кривые
if curvesPlotted > 0
    legend(app.axPlot, 'show', 'Location', 'best');
end
```

### Преимущества решения

1. **Надежность**: Трехуровневая очистка гарантирует удаление всех старых объектов
2. **Безопасность**: Проверка валидности объектов перед удалением
3. **Избирательность**: Удаляются только линии, не трогая другие элементы (например, текстовые аннотации)
4. **Информативность**: Сообщения в консоли о найденных и удаленных объектах

---

## Реализованные изменения

### 1. `plotByColumns.m` (обновлен)

**Изменения:**
- Добавлено явное удаление легенды перед очисткой графика (строки ~42-48)
- Добавлена проверка и удаление оставшихся линий после `cla` (строки ~55-67)
- Добавлено явное удаление легенды перед созданием новой (строки ~200-204)
- Добавлена проверка наличия кривых перед созданием легенды (строки ~206-208)

### 2. `plotByRows.m` (обновлен)

**Изменения:**
- Добавлено явное удаление легенды перед очисткой графика
- Добавлена проверка и удаление оставшихся линий после `cla`
- Добавлено явное удаление легенды перед созданием новой
- Добавлена проверка наличия кривых перед созданием легенды

---

## Тестирование

### Тестовый сценарий

1. **Подготовка данных:**
   - Загрузить данные с тремя кривыми (столбцы 2, 3, 4)

2. **Тест 1: Перетаскивание точки в режиме 'Y'**
   - Выбрать режим 'Y'
   - Перетащить точку на графике
   - **Ожидаемый результат**: 
     - Легенда содержит только один комплект кривых: ["0.1", "0.5", "1"]
     - На графике нет наложенных кривых
     - Редактируемая точка отображается один раз

3. **Тест 2: Множественные перерисовки**
   - Быстро перетащить точку несколько раз
   - **Ожидаемый результат**: 
     - Легенда не накапливает записи
     - График остается чистым

4. **Тест 3: Проверка консоли**
   - Перетащить точку
   - Проверить консоль на наличие предупреждений о найденных линиях
   - **Ожидаемый результат**: 
     - Предупреждения не должны появляться (все линии должны удаляться `cla`)
     - Или предупреждения должны появляться только при проблемах

### Ожидаемое поведение

- ✅ Легенда содержит только один комплект кривых
- ✅ На графике нет наложенных кривых
- ✅ Редактируемая точка отображается один раз
- ✅ При каждой перерисовке график полностью очищается перед построением новых кривых

---

## Дополнительные улучшения

### Рекомендации для будущих улучшений

1. **Оптимизация производительности**: 
   - Кэшировать состояние легенды
   - Избежать лишних проверок при частых обновлениях

2. **Более агрессивная очистка**: 
   - Использовать `reset(app.axPlot)` для полного сброса axes (если нужно)
   - Очищать все дочерние объекты, включая текстовые аннотации

3. **Отладка**: 
   - Добавить счетчик перерисовок для отслеживания частоты обновлений
   - Логировать количество удаленных объектов

---

## Заключение

Проблема была вызвана неполной очисткой графика перед перерисовкой. Решение обеспечивает **надежную очистку** через трехуровневый механизм:

1. **Явное удаление легенды**: Легенда удаляется явно перед очисткой и перед созданием новой
2. **Очистка через `cla`**: Использование стандартной функции очистки
3. **Проверка и удаление оставшихся линий**: Дополнительная проверка и удаление линий, которые могли остаться после `cla`
4. **Создание новой легенды**: Легенда создается только если есть кривые, и только после проверки, что старая удалена

Это гарантирует, что при каждой перерисовке график полностью очищается, и дублирующиеся кривые и записи в легенде не появляются.

---

## Sign-off

**Completed by:** AI Assistant  
**Date:** 2026-01-14  
**Tested by:** User  
**Date:** 2026-01-14  
**Status:** ✅ Complete and Tested  
**Result:** ✅ Проблема решена - график полностью очищается перед перерисовкой, дублирующиеся кривые и записи в легенде не появляются

