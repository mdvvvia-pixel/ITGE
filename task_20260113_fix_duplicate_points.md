# Task: Исправление дублирующихся точек с одинаковой координатой X

**Date:** 2026-01-13  
**Status:** ✅ Complete  
**Priority:** High  
**Assignee:** AI Assistant  
**Related Files:** 
- `TableGraphEditor/src/helpers/updateDataFromGraph.m`

---

## Проблема

При перетаскивании точки в процессе и при окончании перетаскивания периодически возникают вторые точки редактируемой кривой с одинаковой координатой X. Например, у кривой 1 (Column 2) возникают две точки с координатой X = 6.0000.

**Симптомы:**
- При обновлении координаты X в режиме 'XY' или 'X' появляются дублирующиеся точки
- На графике отображаются две или более точки с одинаковой координатой X для одной кривой
- Это приводит к некорректному отображению графика

---

## Анализ причин

### Корневая причина

При обновлении координаты X в режиме 'XY' или 'X' функция `updateDataFromGraph` обновляет координату X в существующей строке данных, но **не проверяет**, не существует ли уже другая строка с таким же X для того же столбца Y.

**Цепочка событий:**

1. **Исходное состояние данных:**
   ```
   Строка 2: X=4.0, Y(столбец 2)=0.5
   Строка 3: X=6.0, Y(столбец 2)=0.6
   Строка 4: X=8.0, Y(столбец 2)=0.7
   ```

2. **Пользователь перетаскивает точку из строки 2, устанавливая X=6.0:**
   - `updateDataFromGraph` обновляет строку 2: `X=6.0, Y(столбец 2)=0.5`

3. **Результат:**
   ```
   Строка 2: X=6.0, Y(столбец 2)=0.5  ← обновлена
   Строка 3: X=6.0, Y(столбец 2)=0.6  ← дубликат!
   Строка 4: X=8.0, Y(столбец 2)=0.7
   ```

4. **При построении графика `plotByColumns`:**
   - График строится из всех данных, включая обе строки с X=6.0
   - На графике появляются две точки с X=6.0 для одной кривой

### Дополнительные факторы

1. **Режим 'XY'**: При свободном перемещении координата X может совпасть с существующей
2. **Режим 'X'**: При изменении только X координата может совпасть с существующей
3. **Режим 'Y'**: Не создает дубликаты, так как координата X не изменяется (уже исправлено ранее)

---

## Решение

### Алгоритм предотвращения дубликатов

Реализован **механизм проверки и удаления дубликатов** перед обновлением координаты X:

1. **Перед обновлением координаты X** (в режимах 'XY' и 'X'):
   - Проверить, не существует ли уже другая строка/столбец с таким же X для того же столбца Y/строки Y
   - Если дубликаты найдены - удалить их (установить NaN)
   - Обновить текущую точку

2. **Проверка дубликатов:**
   - Для режима "по столбцам": проверка по столбцу Y
   - Для режима "по строкам": проверка по строке Y
   - Использование порога сравнения `1e-10` для учета погрешности округления

3. **Удаление дубликатов:**
   - Установка NaN для координат X и Y дублирующихся точек
   - NaN автоматически фильтруется при построении графика в `plotByColumns` и `plotByRows`

### Код решения

#### Для режима "по столбцам" (режимы 'XY' и 'X'):

```matlab
% ВАЖНО: Проверить, не создаст ли обновление X дубликаты
newX = newPosition(1);
xDataAll = currentData(2:end, 1);
yDataCol = currentData(2:end, colY);

% Найти все строки с таким же X для того же столбца Y (кроме текущей)
duplicateRows = [];
for row = 2:size(currentData, 1)
    if row ~= dataRowIdx && isfinite(xDataAll(row-1)) && isfinite(yDataCol(row-1))
        % Проверить, совпадает ли X (с учетом погрешности округления)
        if abs(xDataAll(row-1) - newX) < 1e-10
            duplicateRows = [duplicateRows, row];
        end
    end
end

% Удалить дубликаты (установить NaN)
if ~isempty(duplicateRows)
    fprintf('⚠ Найдены дубликаты по X=%.4f для столбца Y=%d в строках [%s], удаление...\n', ...
        newX, colY, num2str(duplicateRows));
    for dupRow = duplicateRows
        currentData(dupRow, 1) = NaN; % Удалить X
        currentData(dupRow, colY) = NaN; % Удалить Y
    end
end
```

#### Для режима "по строкам" (режимы 'XY' и 'X'):

```matlab
% ВАЖНО: Проверить, не создаст ли обновление X дубликаты
newX = newPosition(1);
xDataRow = currentData(1, 2:end);
yDataRow = currentData(rowY, 2:end);

% Найти все столбцы с таким же X для той же строки Y (кроме текущего)
duplicateCols = [];
for col = 2:size(currentData, 2)
    if col ~= dataColIdx && isfinite(xDataRow(col-1)) && isfinite(yDataRow(col-1))
        % Проверить, совпадает ли X (с учетом погрешности округления)
        if abs(xDataRow(col-1) - newX) < 1e-10
            duplicateCols = [duplicateCols, col];
        end
    end
end

% Удалить дубликаты (установить NaN)
if ~isempty(duplicateCols)
    fprintf('⚠ Найдены дубликаты по X=%.4f для строки Y=%d в столбцах [%s], удаление...\n', ...
        newX, rowY, num2str(duplicateCols));
    for dupCol = duplicateCols
        currentData(1, dupCol) = NaN; % Удалить X
        currentData(rowY, dupCol) = NaN; % Удалить Y
    end
end
```

### Преимущества решения

1. **Проактивная защита**: Дубликаты удаляются ДО обновления данных, предотвращая их появление
2. **Точность**: Использование порога `1e-10` для учета погрешности округления с плавающей точкой
3. **Безопасность**: Проверка валидности данных (`isfinite`) перед сравнением
4. **Информативность**: Сообщения в консоли о найденных и удаленных дубликатах
5. **Автоматическая фильтрация**: NaN автоматически фильтруется при построении графика

---

## Реализованные изменения

### `updateDataFromGraph.m` (обновлен)

**Изменения:**
- Добавлена проверка дубликатов по координате X для режима "по столбцам" (режимы 'XY' и 'X')
- Добавлена проверка дубликатов по координате X для режима "по строкам" (режимы 'XY' и 'X')
- Дубликаты удаляются установкой NaN перед обновлением текущей точки
- Добавлены информативные сообщения в консоль

**Местоположение изменений:**
- Строки ~235-260: Режим "по столбцам", режим 'XY'
- Строки ~226-251: Режим "по столбцам", режим 'X'
- Строки ~438-463: Режим "по строкам", режим 'XY'
- Строки ~429-454: Режим "по строкам", режим 'X'

---

## Тестирование

### Тестовый сценарий

1. **Подготовка данных:**
   - Создать данные с точками: X=[4, 6, 8], Y=[0.5, 0.6, 0.7] для столбца 2

2. **Тест 1: Режим 'XY'**
   - Выбрать режим 'XY'
   - Перетащить точку с X=4.0, установив X=6.0
   - **Ожидаемый результат**: Точка с X=6.0 должна быть удалена, останется только обновленная точка

3. **Тест 2: Режим 'X'**
   - Выбрать режим 'X'
   - Перетащить точку с X=4.0, установив X=6.0
   - **Ожидаемый результат**: Точка с X=6.0 должна быть удалена, останется только обновленная точка

4. **Тест 3: Режим 'Y'**
   - Выбрать режим 'Y'
   - Перетащить точку (координата X не должна изменяться)
   - **Ожидаемый результат**: Дубликаты не должны появляться (координата X не изменяется)

### Ожидаемое поведение

- ✅ При обновлении координаты X дубликаты автоматически удаляются
- ✅ На графике не появляются точки с одинаковой координатой X для одной кривой
- ✅ В консоли появляются сообщения о найденных и удаленных дубликатах
- ✅ Данные остаются валидными после удаления дубликатов

---

## Дополнительные улучшения

### Рекомендации для будущих улучшений

1. **Оптимизация производительности**: 
   - Можно использовать `find` вместо цикла для поиска дубликатов
   - Кэшировать результаты проверки

2. **Валидация данных**: 
   - Добавить проверку дубликатов при загрузке данных
   - Предупреждать пользователя о дубликатах в данных

3. **Восстановление данных**: 
   - Сохранять удаленные дубликаты в истории для возможности отмены
   - Реализовать undo/redo для восстановления удаленных точек

---

## Заключение

Проблема была вызвана тем, что `updateDataFromGraph` не проверяла наличие дубликатов по координате X перед обновлением данных. Решение обеспечивает **проактивную защиту** от дубликатов:

1. **Проверка перед обновлением**: Дубликаты обнаруживаются и удаляются до обновления текущей точки
2. **Точное сравнение**: Использование порога `1e-10` для учета погрешности округления
3. **Безопасное удаление**: Дубликаты помечаются как NaN, что автоматически фильтруется при построении графика

Это гарантирует, что на графике не будут появляться дублирующиеся точки с одинаковой координатой X для одной кривой.

---

## Sign-off

**Completed by:** AI Assistant  
**Date:** 2026-01-13  
**Status:** ✅ Complete  
**Result:** Реализована проверка и удаление дубликатов по координате X при обновлении данных

