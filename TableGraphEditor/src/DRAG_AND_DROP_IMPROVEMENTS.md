# Улучшение функционала перетаскивания точек

**Date:** 2026-01-09  
**Status:** ✅ Implemented  
**Related Task:** `task_20260106_drag_and_drop.md`

---

## Проблема

Точки не зацепляются мышью при клике близко к точке. Зацепление происходит только при клике на значительном расстоянии от точки.

### Симптомы
- При клике прямо на маркере точки перетаскивание не начинается
- При клике на некотором расстоянии от точки перетаскивание работает
- Поведение непредсказуемо и зависит от точности клика

---

## Анализ проблемы

### Корневая причина

**Проблема 1: Использование `IntersectionPoint`**
- `event.IntersectionPoint` работает с линиями, а не с маркерами точек
- При клике на маркере `IntersectionPoint` может:
  - Возвращать координаты линии, а не маркера
  - Быть пустым или недоступным
  - Давать неточные координаты

**Проблема 2: Недостаточный порог расстояния**
- Порог расстояния (5% от диагонали диапазона данных) не учитывает размер маркеров
- Размер маркера в пикселях (6 px) не преобразуется в координаты данных
- Область захвата может быть меньше визуального размера маркера

**Проблема 3: Несоответствие координатных систем**
- `IntersectionPoint` возвращает координаты в системе данных
- Но при клике на маркере эти координаты могут быть неточными
- Нужно использовать более надежный метод получения координат

---

## Решения

### Решение 1: Использование `CurrentPoint` вместо `IntersectionPoint`

**Изменения в `axPlotButtonDown`:**

```matlab
% БЫЛО (ненадежно):
if isprop(event, 'IntersectionPoint')
    clickPos = event.IntersectionPoint;
else
    cp = app.axPlot.CurrentPoint;
    clickPos = cp(1, 1:2);
end

% СТАЛО (надежно):
% CurrentPoint всегда возвращает точные координаты мыши в координатах данных
cp = app.axPlot.CurrentPoint;
clickPos = cp(1, 1:2);
```

**Преимущества:**
- ✅ `CurrentPoint` всегда доступен и точен
- ✅ Работает независимо от того, где произошел клик (на линии, маркере, или рядом)
- ✅ Возвращает координаты в системе координат axes (данные)
- ✅ Не зависит от типа графического объекта

**Файл:** `src/helpers/METHODS_FOR_MLAPP.m` (строки ~519-528)

---

### Решение 2: Учет размера маркеров при вычислении порога расстояния

**Изменения в `findClosestPoint`:**

```matlab
% БЫЛО (не учитывает размер маркеров):
distanceThreshold = 0.05 * diagonal;
if distanceThreshold < 0.01
    distanceThreshold = 0.01;
end

% СТАЛО (учитывает размер маркеров):
% Получить размер axes в пикселях
axPos = getpixelposition(app.axPlot);
axWidthPx = axPos(3);
axHeightPx = axPos(4);

% Размер маркера в пикселях (MarkerSize = 6)
markerSizePx = 6;

% Преобразовать размер маркера в координаты данных
markerSizeX = (markerSizePx * 5.0 / axWidthPx) * xRange;
markerSizeY = (markerSizePx * 5.0 / axHeightPx) * yRange;
markerSizeData = max(markerSizeX, markerSizeY);

% Базовый порог: 5% от диагонали
diagonal = sqrt(xRange^2 + yRange^2);
baseThreshold = 0.05 * diagonal;

% Финальный порог: максимум из базового порога и размера маркера
distanceThreshold = max(baseThreshold, markerSizeData);
```

**Преимущества:**
- ✅ Область захвата соответствует визуальному размеру маркера
- ✅ Адаптивный порог: учитывает масштаб графика
- ✅ Коэффициент 5.0 обеспечивает комфортную область захвата (обновлено с 2.5)
- ✅ Работает для графиков любого масштаба
- ✅ Захват работает при клике прямо на маркере

**Файл:** `src/helpers/findClosestPoint.m` (строки ~65-95)

---

## Технические детали

### Как работает `CurrentPoint`

`CurrentPoint` возвращает матрицу 2×3 с координатами двух точек:
- Первая строка: точка пересечения луча мыши с передней плоскостью axes
- Вторая строка: точка пересечения с задней плоскостью axes

Для 2D графиков используем первую строку: `cp(1, 1:2)`.

### Преобразование пикселей в координаты данных

Формула преобразования:
```
markerSizeData = (markerSizePx * factor / axSizePx) * dataRange
```

Где:
- `markerSizePx` = 6 (размер маркера в пикселях)
- `factor` = 2.5 (коэффициент для комфортной области захвата)
- `axSizePx` = размер axes в пикселях (ширина или высота)
- `dataRange` = диапазон данных (X или Y)

### Выбор коэффициента 5.0

Коэффициент 5.0 выбран эмпирически для обеспечения:
- Достаточной области захвата (не слишком маленькой)
- Захвата при клике прямо на маркере (обновлено с 2.5 до 5.0)
- Комфортного использования (легко попасть в точку)
- Область захвата примерно в 5 раз больше размера маркера в координатах данных

---

## Тестирование

### Рекомендуемые тесты

1. **Тест точного клика:**
   - Кликнуть точно на маркере точки
   - Ожидаемое поведение: точка зацепляется и начинает перетаскиваться

2. **Тест клика рядом с точкой:**
   - Кликнуть в пределах визуального размера маркера
   - Ожидаемое поведение: точка зацепляется

3. **Тест клика далеко от точки:**
   - Кликнуть на значительном расстоянии от точки
   - Ожидаемое поведение: точка не зацепляется

4. **Тест разных масштабов графика:**
   - Тестировать на графиках с разными диапазонами данных
   - Ожидаемое поведение: область захвата адаптируется к масштабу

---

## Альтернативные решения (не реализованы)

### Вариант A: Использование `HitTest` и `PickableParts`

```matlab
% Настроить линии для лучшего захвата
line.HitTest = 'on';
line.PickableParts = 'all';  % Включая маркеры
```

**Почему не используется:**
- Требует изменения функций построения графиков
- Может конфликтовать с другими обработчиками событий
- `CurrentPoint` более универсален

### Вариант B: Увеличение размера маркеров

```matlab
'MarkerSize', 10  % Вместо 6
```

**Почему не используется:**
- Изменяет визуальный вид графика
- Не решает проблему с координатами клика
- Может ухудшить читаемость при большом количестве точек

### Вариант C: Использование `ButtonDownFcn` на линиях

```matlab
line.ButtonDownFcn = @(src,event) axPlotButtonDown(app, src, event);
```

**Почему не используется:**
- Требует изменения функций построения графиков
- Усложняет код
- `CurrentPoint` работает на уровне axes и более универсален

---

## Совместимость

### MATLAB версии
- ✅ R2021a и выше (используются стандартные функции MATLAB)
- ✅ `getpixelposition` доступна во всех версиях
- ✅ `CurrentPoint` доступен во всех версиях

### Платформы
- ✅ Windows
- ✅ macOS
- ✅ Linux

---

## Производительность

### Влияние изменений

**Минимальное влияние:**
- `CurrentPoint` - стандартная операция MATLAB (O(1))
- Преобразование пикселей в координаты - простые вычисления (O(1))
- Общая сложность алгоритма не изменилась: O(n×m), где n - количество кривых, m - количество точек

**Оптимизации:**
- Вычисления выполняются только при клике (не при движении мыши)
- Кэширование размеров axes не требуется (операция быстрая)

---

## Документация

### Обновленные файлы

1. **`src/helpers/METHODS_FOR_MLAPP.m`**
   - Обновлен комментарий для `axPlotButtonDown`
   - Изменен метод получения координат клика

2. **`src/helpers/findClosestPoint.m`**
   - Обновлена документация функции
   - Добавлен расчет порога с учетом размера маркеров

---

## Следующие шаги

1. ✅ Реализованы изменения в коде
2. ⏳ Тестирование пользователем:
   - Проверить зацепление точек при клике близко к точке
   - Проверить зацепление точек при клике на маркере
   - Проверить работу на разных масштабах графика
3. ✅ Коэффициент увеличен с 2.5 до 5.0 для обеспечения захвата при клике прямо на маркере

---

## Заключение

Проблема решена путем:
1. Использования `CurrentPoint` вместо `IntersectionPoint` для точного определения координат клика
2. Учета размера маркеров при вычислении порога расстояния для адаптивной области захвата

Ожидаемый результат: точки должны зацепляться при клике в пределах визуального размера маркера, что обеспечивает интуитивное и комфортное использование функционала перетаскивания.

---

**Автор:** AI Assistant  
**Дата:** 2026-01-09  
**Версия:** 1.0

