# Task: Исправление фиксации координаты X в режиме "только по Y"

**Date:** 2026-01-13  
**Status:** ✅ Complete and Tested (2026-01-13)  
**Priority:** High  
**Assignee:** AI Assistant  
**Related Files:** 
- `TableGraphEditor/src/helpers/updateDataFromGraph.m`
- `TableGraphEditor/src/helpers/applyEditModeConstraints.m`
- `TableGraphEditor/src/helpers/dragPoint.m`

---

## Проблема

При перемещении точки в режиме "только по Y" координата X постоянно "дергалась" в сторону обнуления. В результате точка зафиксировалась с неправильной координатой X (например, 0.2521 вместо исходного 4.000).

**Симптомы:**
- Точка с исходной координатой X = 4.000 при перетаскивании "дергалась" по оси X
- В итоге координата X изменилась на 0.2521
- Это привело к перестроению других кривых

---

## Анализ причин

### Корневая причина

Функция `updateDataFromGraph` **всегда обновляла обе координаты** (X и Y), независимо от режима редактирования:

```matlab
% СТАРАЯ РЕАЛИЗАЦИЯ (НЕПРАВИЛЬНО):
currentData(dataRowIdx, 1) = newPosition(1); % X - ВСЕГДА обновлялась!
currentData(dataRowIdx, colY) = newPosition(2); % Y
```

**Проблема:** Даже если `applyEditModeConstraints` правильно фиксировала координату X в `constrainedPos`, функция `updateDataFromGraph` все равно перезаписывала координату X из `newPosition(1)`, которая могла быть неправильной из-за движения мыши по оси X.

### Цепочка событий

1. **Пользователь выбирает точку** (X = 4.000):
   - `axPlotButtonDown` сохраняет исходные координаты в `dragStartCoordinates` ✅

2. **Пользователь перемещает мышь**:
   - `dragPoint` получает координаты мыши (может быть X ≠ 4.000)
   - `applyEditModeConstraints` правильно фиксирует X = 4.000 в `constrainedPos` ✅
   - `updateDataFromGraph` вызывается с `constrainedPos` ✅

3. **Проблема в `updateDataFromGraph`**:
   - Функция игнорировала режим редактирования ❌
   - Всегда обновляла координату X из `newPosition(1)` ❌
   - Даже если `newPosition(1)` был правильным (из `constrainedPos`), но если где-то была ошибка округления или преобразования координат, X могла измениться ❌

### Дополнительные факторы

1. **Преобразование координат**: При преобразовании координат мыши в координаты данных могли возникать небольшие ошибки округления
2. **Частые обновления**: При быстром движении мыши координаты обновлялись очень часто, и даже небольшие ошибки накапливались
3. **Отсутствие защиты**: Не было защиты от перезаписи фиксированной координаты на уровне `updateDataFromGraph`

---

## Решение

### Алгоритм фиксации координаты X

Реализован **двухуровневый механизм защиты**:

#### Уровень 1: `applyEditModeConstraints` (уже был реализован)
- Фиксирует координату X в `constrainedPos` перед передачей в `updateDataFromGraph`
- Использует исходную координату X из `dragStartCoordinates`

#### Уровень 2: `updateDataFromGraph` (НОВОЕ)
- **Получает режим редактирования** из `app.editMode`
- **В режиме 'Y'**: 
  - Сохраняет исходную координату X из данных ПЕРЕД обновлением
  - Обновляет только координату Y
  - Гарантирует, что координата X НЕ изменится
- **В режиме 'X'**: 
  - Сохраняет исходную координату Y из данных
  - Обновляет только координату X
- **В режиме 'XY'**: 
  - Обновляет обе координаты (как раньше)

### Код решения

```matlab
% Получить режим редактирования
editMode = 'Y';  % По умолчанию 'Y'
% ... получение режима из app.editMode ...

% Обновить данные с учетом режима редактирования
switch editMode
    case 'Y'
        % Режим Y: изменяется только Y, X остается исходным
        originalX = currentData(dataRowIdx, 1);  % Получить ПЕРЕД обновлением
        currentData(dataRowIdx, 1) = originalX; % X - сохранить исходную
        currentData(dataRowIdx, colY) = newPosition(2); % Y - обновить
        
    case 'X'
        % Режим X: изменяется только X, Y остается исходным
        originalY = currentData(dataRowIdx, colY);
        currentData(dataRowIdx, 1) = newPosition(1); % X - обновить
        currentData(dataRowIdx, colY) = originalY; % Y - сохранить исходную
        
    case 'XY'
        % Режим XY: изменяются обе координаты
        currentData(dataRowIdx, 1) = newPosition(1); % X
        currentData(dataRowIdx, colY) = newPosition(2); % Y
end
```

### Преимущества решения

1. **Двойная защита**: 
   - `applyEditModeConstraints` фиксирует координату на уровне входных данных
   - `updateDataFromGraph` фиксирует координату на уровне обновления данных

2. **Надежность**: 
   - Даже если `applyEditModeConstraints` по какой-то причине не сработает, `updateDataFromGraph` все равно защитит координату X

3. **Использование актуальных данных**: 
   - Исходная координата X берется из `currentData` ПЕРЕД обновлением
   - Это гарантирует, что мы используем актуальные данные, а не устаревшие из `dragStartCoordinates`

4. **Поддержка всех режимов**: 
   - Режим 'X' - фиксирует Y
   - Режим 'Y' - фиксирует X
   - Режим 'XY' - обновляет обе координаты

---

## Реализованные изменения

### 1. `updateDataFromGraph.m` (обновлен)

**Изменения:**
- Добавлено получение режима редактирования из `app.editMode`
- Добавлена логика switch для обработки режимов 'X', 'Y', 'XY'
- В режиме 'Y' координата X сохраняется из данных перед обновлением
- В режиме 'X' координата Y сохраняется из данных перед обновлением
- Обновлены комментарии и сообщения отладки

**Файлы:**
- `TableGraphEditor/src/helpers/updateDataFromGraph.m` (строки 185-230 для режима "по столбцам", строки 277-322 для режима "по строкам")

### 2. Обновлена документация

**Изменения:**
- Обновлен комментарий в начале файла `updateDataFromGraph.m`
- Добавлено описание поддержки режимов редактирования

---

## Тестирование

### Тестовый сценарий

1. **Запустить программу** → режим 'Y' должен быть установлен по умолчанию
2. **Выбрать точку** с координатой X = 4.000
3. **Переместить мышь** в разные стороны (включая движение по оси X)
4. **Проверить**: координата X должна остаться 4.000, изменяется только Y

### Ожидаемое поведение

- ✅ Координата X остается постоянной (4.000) при любом движении мыши
- ✅ Координата Y изменяется в соответствии с движением мыши
- ✅ Другие кривые не перестраиваются из-за изменения X
- ✅ В консоли отладки должны быть сообщения: "Обновлены данные (режим Y): ... X (сохранен: 4.000) ..."

---

## Дополнительные улучшения

### Рекомендации для будущих улучшений

1. **Кэширование исходных координат**: 
   - Можно сохранять исходные координаты X и Y в `dragStartCoordinates` при начале перетаскивания
   - Использовать их в `updateDataFromGraph` вместо получения из данных
   - Это обеспечит еще большую надежность

2. **Валидация координат**: 
   - Добавить проверку, что координата X не изменилась в режиме 'Y'
   - Добавить предупреждение, если координата изменилась (для отладки)

3. **Оптимизация производительности**: 
   - Кэшировать режим редактирования в локальной переменной
   - Избежать повторного получения из `app.editMode` при каждом вызове

---

## Заключение

Проблема была вызвана тем, что `updateDataFromGraph` не учитывала режим редактирования и всегда обновляла обе координаты. Решение обеспечивает **двухуровневую защиту** фиксированной координаты:

1. **Уровень 1**: `applyEditModeConstraints` фиксирует координату в `constrainedPos`
2. **Уровень 2**: `updateDataFromGraph` фиксирует координату при обновлении данных

Это гарантирует, что координата X останется постоянной в режиме 'Y', даже при ошибках округления или преобразования координат.

---

## Sign-off

**Completed by:** AI Assistant  
**Date:** 2026-01-13  
**Tested by:** User  
**Date:** 2026-01-13  
**Status:** ✅ Complete and Tested  
**Result:** ✅ Проблема решена - координата X надежно фиксируется в режиме 'Y'

